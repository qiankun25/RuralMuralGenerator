# 📖 使用文档

## 目录

1. [系统概述](#系统概述)
2. [用户界面使用](#用户界面使用)
3. [API接口使用](#api接口使用)
4. [高级功能](#高级功能)
5. [常见问题](#常见问题)

---

## 系统概述

乡村墙绘AI生成系统是一个基于多智能体协作的AI应用，能够为每个乡村生成独特的文化墙绘设计。

### 核心功能

- **文化分析**：深度分析乡村文化特色，提取核心文化元素
- **创意设计**：生成3个不同风格的墙绘设计方案
- **图像生成**：使用AI图像生成技术创作高质量墙绘图像
- **结果导出**：下载图像和完整设计报告

### 技术特点

- 🤖 **多智能体协作**：CrewAI编排 + LangChain实现
- 📚 **RAG技术**：基于ChromaDB的语义检索
- 🎨 **个性化设计**：每个乡村都有独特的设计方案
- 🖼️ **AI图像生成**：通义万相API生成高质量图像

---

## 用户界面使用

### 步骤1：输入乡村信息

访问 http://localhost:8501，填写以下信息：

#### 必填项

- **乡村名称**：例如"西递村"
- **地理位置**：例如"安徽省黄山市"

#### 选填项

- **特色产业**：例如"旅游、茶叶种植"
- **历史故事**：详细描述乡村的历史背景、文化特色
- **设计风格偏好**：选择传统/现代/叙事风格
- **其他要求**：特殊的设计要求

#### 示例输入

```
乡村名称：西递村
地理位置：安徽省黄山市
特色产业：旅游、徽派建筑保护
历史故事：西递村始建于北宋，是典型的徽派建筑古村落，
         以马头墙、青砖黛瓦、精美木雕闻名，是世界文化遗产。
         村中保存着明清古建筑124幢，体现了徽商文化和
         耕读传家的传统。
设计风格：传统文化风格
```

### 步骤2：查看文化分析

系统将自动：
1. 从ChromaDB检索相关村落知识
2. 查询政府开放数据平台
3. 使用LLM进行深度分析

**分析结果包含**：
- 核心文化元素
- 推荐色彩方案
- 推荐文化符号
- 设计建议
- 文化故事线索

**操作选项**：
- ✅ 继续生成设计方案
- 🔄 重新分析
- ⬅️ 返回修改输入

### 步骤3：选择设计方案

系统将生成3个不同风格的设计方案：

- **方案A**：传统文化风格
- **方案B**：现代简约风格
- **方案C**：文化叙事风格

每个方案包含：
- 设计主题
- 核心元素
- 色彩搭配
- 构图建议
- 文化寓意
- 图像生成Prompt

**操作选项**：
- ✅ 选择方案A/B/C
- 🔄 重新生成方案
- ⬅️ 返回文化分析

### 步骤4：生成图像

系统将：
1. 提取选定方案的图像Prompt
2. 调用通义万相API生成图像
3. 显示生成进度（约60-90秒）

**注意**：
- 如未配置API密钥，将返回Mock示例图像
- 图像生成需要消耗API额度

### 步骤5：下载结果

**可下载内容**：
- 🖼️ 墙绘设计图像（PNG格式）
- 📄 完整设计报告（包含文化分析和设计方案）

**后续操作**：
- 🔄 重新生成图像
- 🎨 选择其他方案
- 🆕 开始新项目

---

## API接口使用

### 基础URL

```
http://localhost:8000/api
```

### 1. 健康检查

**请求**：
```http
GET /api/health
```

**响应**：
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "api_keys_configured": {
    "dashscope": true,
    "government": true
  },
  "chromadb_status": "healthy (3 documents)"
}
```

### 2. 文化分析

**请求**：
```http
POST /api/analyze
Content-Type: application/json

{
  "village_info": {
    "name": "西递村",
    "location": "安徽省黄山市",
    "industry": "旅游",
    "history": "明清古村落..."
  }
}
```

**响应**：
```json
{
  "status": "success",
  "message": "文化分析完成",
  "culture_analysis": "## 核心文化元素\n...",
  "data_sources": ["ChromaDB知识库", "政府开放数据平台", "通义千问AI分析"]
}
```

### 3. 设计方案生成

**请求**：
```http
POST /api/design
Content-Type: application/json

{
  "culture_analysis": "## 核心文化元素\n...",
  "user_preference": "希望突出木雕元素"
}
```

**响应**：
```json
{
  "status": "success",
  "message": "设计方案生成完成",
  "design_schema": "## 方案A：传统文化风格\n...",
  "num_options": 3
}
```

### 4. 图像生成（异步）

**请求**：
```http
POST /api/generate-image
Content-Type: application/json

{
  "design_option": "方案A的完整内容...",
  "style_preference": "traditional"
}
```

**响应**：
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "pending",
  "progress": 0
}
```

### 5. 查询任务状态

**请求**：
```http
GET /api/task/{task_id}
```

**响应**：
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "completed",
  "progress": 100,
  "result": {
    "status": "success",
    "images": [
      {
        "url": "",
        "local_path": "./data/generated_images/generated_20251013_143000_0.png"
      }
    ],
    "prompt": "A beautiful Chinese village mural...",
    "style": "traditional",
    "is_mock": false
  }
}
```

---

## 高级功能

### 自定义知识库

#### 添加村落知识

1. 在 `data/knowledge/villages/` 目录下创建新的txt文件
2. 按照以下格式编写：

```
村落名称：XXX村
所属地区：XX省XX市
村落类型：传统村落

【历史沿革】
...

【建筑特色】
...

【文化内涵】
...

【设计建议】
...
```

3. 运行 `scripts/init_chromadb.bat` 重新初始化知识库

#### 添加设计案例

1. 在 `data/knowledge/design_cases/` 目录下创建新的txt文件
2. 按照以下格式编写：

```
设计案例：XXX墙绘 - XXX风格

【项目背景】
...

【设计理念】
...

【核心元素】
...

【色彩搭配】
...
```

### 调整LLM参数

编辑 `.env` 文件：

```env
# LLM温度参数（0-1，越高越有创意）
LLM_TEMPERATURE=0.7

# LLM最大token数
LLM_MAX_TOKENS=2000

# LLM模型名称
LLM_MODEL_NAME=qwen-plus
```

### 自定义图像风格

在调用图像生成API时，可以指定不同的风格：

```json
{
  "style_preference": "traditional"  // traditional/modern/narrative
}
```

---

## 常见问题

### Q1: 文化分析结果不准确怎么办？

**A**: 
1. 在输入时提供更详细的历史故事和文化特色
2. 添加更多相关村落知识到ChromaDB
3. 点击"重新分析"按钮重新生成

### Q2: 设计方案不满意怎么办？

**A**:
1. 在"设计偏好"中提出具体要求
2. 点击"重新生成方案"获取新的方案
3. 可以多次重新生成直到满意

### Q3: 图像生成失败怎么办？

**A**:
1. 检查API密钥是否正确配置
2. 检查账户余额是否充足
3. 如果API不可用，系统会返回Mock图像用于演示

### Q4: 如何提高生成速度？

**A**:
- 文化分析：约30秒（取决于LLM响应速度）
- 设计方案：约40秒
- 图像生成：约60-90秒（取决于API服务器负载）

总时间约2-3分钟，这是正常的处理时间。

### Q5: 可以批量生成吗？

**A**: 
当前版本不支持批量生成。如需批量处理，可以：
1. 使用API接口编写自动化脚本
2. 多次运行前端界面

### Q6: 生成的图像可以商用吗？

**A**: 
- 图像由AI生成，使用前请查看通义万相的服务协议
- 建议将AI生成的图像作为设计参考，由专业设计师进一步优化

---

## 技术支持

如遇到其他问题，请：
1. 查看后端日志：`logs/app.log`
2. 检查API文档：http://localhost:8000/docs
3. 查看项目README：`README.md`

