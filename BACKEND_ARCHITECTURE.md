# ğŸ¡ ä¹¡æ‘å¢™ç»˜AIç”Ÿæˆç³»ç»Ÿ - åç«¯æ¶æ„è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒå±‚çº§è¯´æ˜](#æ ¸å¿ƒå±‚çº§è¯´æ˜)
3. [æ•°æ®æµå¤„ç†](#æ•°æ®æµå¤„ç†)
4. [å…³é”®æ¨¡å—è¯¦è§£](#å…³é”®æ¨¡å—è¯¦è§£)
5. [APIæ¥å£è¯´æ˜](#apiæ¥å£è¯´æ˜)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Streamlitå‰ç«¯ (8501)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP REST API
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPIåç«¯ (8000) - main.py                    â”‚
â”‚  â”œâ”€ CORSä¸­é—´ä»¶é…ç½®                                           â”‚
â”‚  â”œâ”€ æ—¥å¿—ç³»ç»Ÿï¼ˆLoguruï¼‰                                       â”‚
â”‚  â””â”€ å¯åŠ¨/å…³é—­äº‹ä»¶å¤„ç†                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIè·¯ç”±å±‚   â”‚  â”‚  ä¸šåŠ¡é€»è¾‘å±‚  â”‚  â”‚  æ•°æ®å±‚      â”‚
â”‚ (routes.py)  â”‚  â”‚ (agents/)    â”‚  â”‚ (services/)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒå±‚çº§è¯´æ˜

### 1ï¸âƒ£ **FastAPIåº”ç”¨å±‚** (`backend/main.py`)

**èŒè´£**ï¼š
- åˆ›å»ºFastAPIåº”ç”¨å®ä¾‹
- é…ç½®CORSä¸­é—´ä»¶ï¼ˆå…è®¸Streamlitè·¨åŸŸè®¿é—®ï¼‰
- æ³¨å†ŒAPIè·¯ç”±
- ç®¡ç†åº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

**å…³é”®ä»£ç **ï¼š
```python
app = FastAPI(
    title="ä¹¡æ‘å¢™ç»˜AIç”Ÿæˆç³»ç»Ÿ",
    version="1.0.0"
)

# å¯åŠ¨äº‹ä»¶ï¼šåˆå§‹åŒ–ChromaDBã€éªŒè¯APIå¯†é’¥
@app.on_event("startup")
async def startup_event():
    chromadb_service.initialize()
    settings.validate_api_keys()
```

---

### 2ï¸âƒ£ **APIè·¯ç”±å±‚** (`backend/api/routes.py`)

**èŒè´£**ï¼š
- å®šä¹‰RESTfulæ¥å£
- å¤„ç†HTTPè¯·æ±‚/å“åº”
- ç®¡ç†å¼‚æ­¥ä»»åŠ¡

**æ ¸å¿ƒæ¥å£**ï¼š

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ | ç±»å‹ |
|------|------|------|------|
| `/api/health` | GET | å¥åº·æ£€æŸ¥ | åŒæ­¥ |
| `/api/analyze` | POST | æ–‡åŒ–åˆ†æ | åŒæ­¥ |
| `/api/design` | POST | è®¾è®¡æ–¹æ¡ˆç”Ÿæˆ | åŒæ­¥ |
| `/api/generate-image` | POST | å›¾åƒç”Ÿæˆ | å¼‚æ­¥ |
| `/api/task/{task_id}` | GET | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ | åŒæ­¥ |
| `/api/refine-design` | POST | è®¾è®¡ä¼˜åŒ– | åŒæ­¥ |

**å¼‚æ­¥ä»»åŠ¡ç®¡ç†**ï¼š
```python
tasks_storage: Dict[str, Dict] = {}  # å†…å­˜å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒç”¨Redisï¼‰

# ä»»åŠ¡çŠ¶æ€æµè½¬ï¼špending â†’ processing â†’ completed/failed
```

---

### 3ï¸âƒ£ **ä¸šåŠ¡é€»è¾‘å±‚** (`backend/agents/`)

#### **æ–‡åŒ–åˆ†æAgent** (`culture_analyst.py`)

**å¤„ç†æµç¨‹**ï¼š
```
æ‘è½ä¿¡æ¯è¾“å…¥
    â†“
[æ­¥éª¤1] ä»ChromaDBæ£€ç´¢ç›¸å…³çŸ¥è¯†
    â†“
[æ­¥éª¤2] æŸ¥è¯¢æ”¿åºœå¼€æ”¾æ•°æ®
    â†“
[æ­¥éª¤3] ä½¿ç”¨LLMè¿›è¡Œæ·±åº¦åˆ†æ
    â†“
è¾“å‡ºï¼šæ–‡åŒ–åˆ†ææŠ¥å‘Šï¼ˆMarkdownæ ¼å¼ï¼‰
```

**å…³é”®æ–¹æ³•**ï¼š
- `analyze(village_info)` - ä¸»åˆ†ææ–¹æ³•
- `_retrieve_knowledge()` - çŸ¥è¯†åº“æ£€ç´¢
- `_query_government_data()` - æ”¿åºœæ•°æ®æŸ¥è¯¢
- `_generate_analysis()` - LLMåˆ†æ

#### **åˆ›æ„è®¾è®¡Agent** (`creative_designer.py`)

**å¤„ç†æµç¨‹**ï¼š
```
æ–‡åŒ–åˆ†ææŠ¥å‘Š + ç”¨æˆ·åå¥½
    â†“
[æ­¥éª¤1] æ£€ç´¢è®¾è®¡æ¡ˆä¾‹å‚è€ƒ
    â†“
[æ­¥éª¤2] ä½¿ç”¨LLMç”Ÿæˆ3ä¸ªè®¾è®¡æ–¹æ¡ˆ
    â†“
[æ­¥éª¤3] æ•æ„Ÿè¯æ£€æµ‹
    â†“
è¾“å‡ºï¼š3ä¸ªè®¾è®¡æ–¹æ¡ˆï¼ˆMarkdownæ ¼å¼ï¼‰
```

**å…³é”®æ–¹æ³•**ï¼š
- `generate_designs()` - ç”Ÿæˆè®¾è®¡æ–¹æ¡ˆ
- `extract_image_prompt()` - æå–å›¾åƒPrompt
- `refine_design()` - æ ¹æ®åé¦ˆä¼˜åŒ–è®¾è®¡

#### **å›¾åƒç”ŸæˆAgent** (`image_generator.py`)

**å¤„ç†æµç¨‹**ï¼š
```
å›¾åƒPrompt + é£æ ¼åå¥½
    â†“
è°ƒç”¨å›¾åƒç”ŸæˆæœåŠ¡
    â†“
è¾“å‡ºï¼šç”Ÿæˆçš„å›¾åƒï¼ˆæœ¬åœ°è·¯å¾„æˆ–URLï¼‰
```

#### **CrewAIå·¥ä½œæµç®¡ç†å™¨** (`crew_manager.py`)

**èŒè´£**ï¼š
- ç¼–æ’å¤šä¸ªAgentçš„åä½œæµç¨‹
- æ”¯æŒåˆ†æ­¥æ‰§è¡Œå’Œå®Œæ•´å·¥ä½œæµ
- æä¾›è¿›åº¦å›è°ƒæœºåˆ¶

---

### 4ï¸âƒ£ **æœåŠ¡å±‚** (`backend/services/`)

#### **ChromaDBæœåŠ¡** (`chromadb_service.py`)

**åŠŸèƒ½**ï¼š
- å‘é‡æ•°æ®åº“åˆå§‹åŒ–å’Œç®¡ç†
- æ‘è½çŸ¥è¯†åº“ç®¡ç†
- è®¾è®¡æ¡ˆä¾‹åº“ç®¡ç†
- è¯­ä¹‰æ£€ç´¢

**å…³é”®æ–¹æ³•**ï¼š
```python
initialize()              # åˆå§‹åŒ–ChromaDB
add_villages()           # æ·»åŠ æ‘è½çŸ¥è¯†
add_design_cases()       # æ·»åŠ è®¾è®¡æ¡ˆä¾‹
search_villages()        # æœç´¢æ‘è½çŸ¥è¯†
search_design_cases()    # æœç´¢è®¾è®¡æ¡ˆä¾‹
```

**ä¸¤ä¸ªé›†åˆ**ï¼š
- `villages_knowledge` - æ‘è½æ–‡åŒ–çŸ¥è¯†åº“
- `design_cases` - å¢™ç»˜è®¾è®¡æ¡ˆä¾‹åº“

#### **LLMæœåŠ¡** (`llm_service.py`)

**åŠŸèƒ½**ï¼š
- é€šä¹‰åƒé—®APIå°è£…
- æ–‡æœ¬ç”Ÿæˆå’Œå¯¹è¯
- ä¸“ç”¨æ¥å£ï¼ˆæ–‡åŒ–åˆ†æã€è®¾è®¡ç”Ÿæˆã€Promptä¼˜åŒ–ï¼‰

**å…³é”®æ–¹æ³•**ï¼š
```python
chat()                    # é€šç”¨å¯¹è¯
generate_text()          # æ–‡æœ¬ç”Ÿæˆ
analyze_culture()        # æ–‡åŒ–åˆ†æä¸“ç”¨
generate_design_options() # è®¾è®¡ç”Ÿæˆä¸“ç”¨
refine_image_prompt()    # Promptä¼˜åŒ–
```

#### **å›¾åƒç”ŸæˆæœåŠ¡** (`image_service.py`)

**åŠŸèƒ½**ï¼š
- é€šä¹‰ä¸‡ç›¸APIå°è£…
- å›¾åƒä¸‹è½½å’Œå­˜å‚¨
- Mockå›¾åƒé™çº§æ–¹æ¡ˆ

**å…³é”®æ–¹æ³•**ï¼š
```python
generate_image()         # ç”Ÿæˆå›¾åƒ
generate_mural_image()   # å¢™ç»˜å›¾åƒç”Ÿæˆï¼ˆé«˜çº§ï¼‰
_download_image()        # ä¸‹è½½å›¾åƒ
_get_mock_image()        # Mockå›¾åƒé™çº§
```

#### **æ”¿åºœæ•°æ®æœåŠ¡** (`government_service.py`)

**åŠŸèƒ½**ï¼š
- æ”¿åºœå¼€æ”¾æ•°æ®APIè°ƒç”¨
- Mockæ•°æ®æ”¯æŒ
- ç¼“å­˜æœºåˆ¶

---

### 5ï¸âƒ£ **å·¥å…·å±‚** (`backend/tools/`)

#### **ChromaDBå·¥å…·** (`chromadb_tool.py`)

LangChain Toolï¼Œç”¨äºAgentè°ƒç”¨ï¼š
- `search_village_knowledge()` - æœç´¢æ‘è½çŸ¥è¯†
- `search_design_cases()` - æœç´¢è®¾è®¡æ¡ˆä¾‹

#### **æ”¿åºœAPIå·¥å…·** (`government_api_tool.py`)

LangChain Toolï¼Œç”¨äºAgentè°ƒç”¨ï¼š
- `query_government_data()` - æŸ¥è¯¢æ”¿åºœæ•°æ®

#### **æ•æ„Ÿè¯æ£€æµ‹å·¥å…·** (`sensitive_check_tool.py`)

LangChain Toolï¼Œç”¨äºå†…å®¹å®¡æ ¸ï¼š
- `check_text()` - æ£€æµ‹æ•æ„Ÿè¯

---

### 6ï¸âƒ£ **é…ç½®å±‚** (`backend/core/config.py`)

**åŠŸèƒ½**ï¼š
- ä½¿ç”¨Pydantic Settingsç®¡ç†ç¯å¢ƒå˜é‡
- éªŒè¯APIå¯†é’¥
- ç¡®ä¿å¿…è¦ç›®å½•å­˜åœ¨

**é…ç½®åˆ†ç±»**ï¼š
- LLM APIé…ç½®ï¼ˆDashScopeï¼‰
- å¤–éƒ¨æ•°æ®APIé…ç½®ï¼ˆæ”¿åºœæ•°æ®ï¼‰
- æ•°æ®åº“é…ç½®ï¼ˆChromaDBã€SQLiteï¼‰
- åº”ç”¨é…ç½®ï¼ˆä¸»æœºã€ç«¯å£ã€æ—¥å¿—ï¼‰
- å›¾åƒç”Ÿæˆé…ç½®
- æ•æ„Ÿè¯æ£€æµ‹é…ç½®

---

## æ•°æ®æµå¤„ç†

### å®Œæ•´å·¥ä½œæµæ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ï¼ˆæ‘è½ä¿¡æ¯ï¼‰
    â†“
[API] POST /api/analyze
    â†“
[Agent] æ–‡åŒ–åˆ†æAgent
    â”œâ”€ [Service] ChromaDBæ£€ç´¢æ‘è½çŸ¥è¯†
    â”œâ”€ [Service] æ”¿åºœAPIæŸ¥è¯¢æ•°æ®
    â””â”€ [Service] LLMè¿›è¡Œæ·±åº¦åˆ†æ
    â†“
è¿”å›ï¼šæ–‡åŒ–åˆ†ææŠ¥å‘Š
    â†“
[API] POST /api/design
    â†“
[Agent] åˆ›æ„è®¾è®¡Agent
    â”œâ”€ [Service] ChromaDBæ£€ç´¢è®¾è®¡æ¡ˆä¾‹
    â”œâ”€ [Service] LLMç”Ÿæˆ3ä¸ªè®¾è®¡æ–¹æ¡ˆ
    â””â”€ [Tool] æ•æ„Ÿè¯æ£€æµ‹
    â†“
è¿”å›ï¼š3ä¸ªè®¾è®¡æ–¹æ¡ˆ
    â†“
[API] POST /api/generate-image (å¼‚æ­¥)
    â†“
[åå°ä»»åŠ¡] _generate_image_task
    â”œâ”€ [Agent] å›¾åƒç”ŸæˆAgent
    â”œâ”€ [Service] å›¾åƒç”ŸæˆæœåŠ¡
    â””â”€ æ›´æ–°ä»»åŠ¡çŠ¶æ€
    â†“
[API] GET /api/task/{task_id}
    â†“
è¿”å›ï¼šä»»åŠ¡çŠ¶æ€å’Œç»“æœ
```

---

## å…³é”®æ¨¡å—è¯¦è§£

### é…ç½®ç®¡ç†æµç¨‹

```python
# 1. ä».envæ–‡ä»¶åŠ è½½é…ç½®
settings = Settings()

# 2. éªŒè¯APIå¯†é’¥
api_keys_status = settings.validate_api_keys()

# 3. ç¡®ä¿ç›®å½•å­˜åœ¨
settings.ensure_directories()
```

### çŸ¥è¯†åº“åˆå§‹åŒ–æµç¨‹

```python
# 1. å¯åŠ¨æ—¶åˆå§‹åŒ–ChromaDB
chromadb_service.initialize()

# 2. åŠ è½½æ‘è½çŸ¥è¯†å’Œè®¾è®¡æ¡ˆä¾‹
# é€šè¿‡ scripts/init_chromadb.py åˆå§‹åŒ–

# 3. æ”¯æŒå‘é‡æ£€ç´¢
results = chromadb_service.search_villages(query)
```

### å¼‚æ­¥ä»»åŠ¡å¤„ç†æµç¨‹

```python
# 1. åˆ›å»ºä»»åŠ¡
task_id = str(uuid.uuid4())
tasks_storage[task_id] = {
    "status": "pending",
    "progress": 0,
    ...
}

# 2. æ·»åŠ åå°ä»»åŠ¡
background_tasks.add_task(_generate_image_task, ...)

# 3. è½®è¯¢æŸ¥è¯¢çŠ¶æ€
GET /api/task/{task_id}

# 4. ä»»åŠ¡å®Œæˆ
tasks_storage[task_id]["status"] = "completed"
```

---

## APIæ¥å£è¯´æ˜

### 1. å¥åº·æ£€æŸ¥

```
GET /api/health

å“åº”ï¼š
{
    "status": "healthy",
    "version": "1.0.0",
    "api_keys_configured": {
        "dashscope": true,
        "government": false,
        "wenxin": false
    },
    "chromadb_status": "healthy (5 documents)"
}
```

### 2. æ–‡åŒ–åˆ†æ

```
POST /api/analyze

è¯·æ±‚ï¼š
{
    "village_info": {
        "name": "è¥¿é€’æ‘",
        "location": "å®‰å¾½çœé»„å±±å¸‚",
        "industry": "æ—…æ¸¸ã€å¾½æ´¾å»ºç­‘ä¿æŠ¤",
        "history": "æ˜æ¸…å¤æ‘è½"
    }
}

å“åº”ï¼š
{
    "status": "success",
    "culture_analysis": "## æ ¸å¿ƒæ–‡åŒ–å…ƒç´ \n...",
    "data_sources": ["ChromaDBçŸ¥è¯†åº“", "æ”¿åºœå¼€æ”¾æ•°æ®å¹³å°", "é€šä¹‰åƒé—®AIåˆ†æ"]
}
```

### 3. è®¾è®¡æ–¹æ¡ˆç”Ÿæˆ

```
POST /api/design

è¯·æ±‚ï¼š
{
    "culture_analysis": "...",
    "user_preference": "åå¥½ç°ä»£é£æ ¼"
}

å“åº”ï¼š
{
    "status": "success",
    "design_options": "## æ–¹æ¡ˆAï¼šä¼ ç»Ÿæ–‡åŒ–é£æ ¼\n...",
    "num_options": 3
}
```

### 4. å›¾åƒç”Ÿæˆï¼ˆå¼‚æ­¥ï¼‰

```
POST /api/generate-image

è¯·æ±‚ï¼š
{
    "design_option": "...",
    "style_preference": "traditional",
    "image_prompt": "å¯é€‰çš„è‡ªå®šä¹‰Prompt"
}

å“åº”ï¼š
{
    "task_id": "uuid",
    "status": "pending",
    "progress": 0,
    "message": "å›¾åƒç”Ÿæˆä»»åŠ¡å·²åˆ›å»º"
}

æŸ¥è¯¢çŠ¶æ€ï¼š
GET /api/task/{task_id}

å“åº”ï¼š
{
    "task_id": "uuid",
    "status": "completed",
    "progress": 100,
    "result": {
        "status": "success",
        "images": [{"url": "...", "local_path": "..."}]
    }
}
```

---

## æŠ€æœ¯æ ˆæ€»ç»“

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | ä½œç”¨ |
|------|------|------|------|
| **Webæ¡†æ¶** | FastAPI | 0.109.0 | RESTful APIã€å¼‚æ­¥å¤„ç† |
| **Agentç¼–æ’** | CrewAI | 0.1.26 | å¤šAgentå·¥ä½œæµç®¡ç† |
| **Agentå®ç°** | LangChain | 0.1.0 | Agenté€»è¾‘ã€Memoryã€Tools |
| **å‘é‡æ•°æ®åº“** | ChromaDB | 0.4.22 | RAGçŸ¥è¯†åº“ |
| **LLM** | é€šä¹‰åƒé—® | qwen-plus | æ–‡æœ¬ç”Ÿæˆã€åˆ†æ |
| **å›¾åƒç”Ÿæˆ** | é€šä¹‰ä¸‡ç›¸ | wanx-v1 | å¢™ç»˜å›¾åƒç”Ÿæˆ |
| **æ—¥å¿—** | Loguru | - | ç»“æ„åŒ–æ—¥å¿— |
| **é…ç½®** | Pydantic | - | ç¯å¢ƒå˜é‡ç®¡ç† |

---

## æ€»ç»“

åç«¯é‡‡ç”¨**åˆ†å±‚æ¶æ„**è®¾è®¡ï¼š
- **APIå±‚**ï¼šå¤„ç†HTTPè¯·æ±‚/å“åº”
- **ä¸šåŠ¡é€»è¾‘å±‚**ï¼šå¤šAgentåä½œå¤„ç†
- **æœåŠ¡å±‚**ï¼šå°è£…å¤–éƒ¨APIå’Œæ•°æ®åº“
- **å·¥å…·å±‚**ï¼šLangChainå·¥å…·é›†
- **é…ç½®å±‚**ï¼šç»Ÿä¸€é…ç½®ç®¡ç†

æ•´ä¸ªç³»ç»Ÿé€šè¿‡**RAG + LLM + å¤šAgentåä½œ**å®ç°ä¹¡æ‘å¢™ç»˜çš„ä¸ªæ€§åŒ–è®¾è®¡ç”Ÿæˆã€‚

