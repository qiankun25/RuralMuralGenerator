# ä¹¡æ‘å¢™ç»˜å¤šæ™ºèƒ½ä½“ç³»ç»Ÿé¡¹ç›®æŠ¥å‘Š

## 1. é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ„å»ºäº†ä¸€ä¸ªåŸºäºå¤šæ™ºèƒ½ä½“åä½œçš„ä¹¡æ‘å¢™ç»˜è®¾è®¡ç³»ç»Ÿ,é€šè¿‡æ–‡åŒ–åˆ†æã€åˆ›æ„è®¾è®¡å’Œå›¾åƒç”Ÿæˆä¸‰ä¸ªä¸“ä¸šæ™ºèƒ½ä½“çš„ååŒå·¥ä½œ,ä¸ºä¹¡æ‘å¢™ç»˜é¡¹ç›®æä¾›ä»æ–‡åŒ–æŒ–æ˜åˆ°è§†è§‰å‘ˆç°çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚ç³»ç»Ÿé‡‡ç”¨çŠ¶æ€æœºé©±åŠ¨çš„å·¥ä½œæµç®¡ç†,æ”¯æŒç”¨æˆ·åœ¨å„ä¸ªç¯èŠ‚è¿›è¡Œç¡®è®¤å’Œä¿®æ”¹,ç¡®ä¿æœ€ç»ˆè®¾è®¡æ–¹æ¡ˆç¬¦åˆä¹¡æ‘æ–‡åŒ–ç‰¹è‰²å’Œç”¨æˆ·æœŸæœ›ã€‚

**æ ¸å¿ƒåŠŸèƒ½:**
- æ™ºèƒ½æ–‡åŒ–åˆ†æ:æ·±åº¦æŒ–æ˜ä¹¡æ‘å†å²ã€æ°‘ä¿—ã€äº§ä¸šç­‰æ–‡åŒ–è¦ç´ 
- åˆ›æ„æ–¹æ¡ˆè®¾è®¡:åŸºäºæ–‡åŒ–åˆ†æç”Ÿæˆå¤šä¸ªå·®å¼‚åŒ–è®¾è®¡æ–¹æ¡ˆ
- å›¾åƒpromptç”Ÿæˆ:å°†è®¾è®¡æ–¹æ¡ˆè½¬åŒ–ä¸ºå¯æ‰§è¡Œçš„å›¾åƒç”ŸæˆæŒ‡ä»¤
- äº¤äº’å¼è¿­ä»£:æ”¯æŒç”¨æˆ·åœ¨æ¯ä¸ªé˜¶æ®µæå‡ºåé¦ˆå’Œä¿®æ”¹è¦æ±‚

## 2. æŠ€æœ¯æ¶æ„

## æ¶æ„è®¾è®¡
```mermaid
graph TB
    subgraph "ç”¨æˆ·äº¤äº’å±‚"
        U[ç”¨æˆ·è¾“å…¥] --> UI[å¯¹è¯ç•Œé¢]
    end
    
    subgraph "æ„å›¾ç†è§£ä¸è·¯ç”±å±‚"
        UI --> M[ç»ç†æ™ºèƒ½ä½“<br/>Manager Agent]
        M --> IP[æ„å›¾è§£æå™¨<br/>Intent Parser]
        IP --> |è§£æç»“æœ| DC{å†³ç­–ä¸­å¿ƒ<br/>Decision Core}
    end
    
    subgraph "çŠ¶æ€ç®¡ç†"
        DC --> SM[çŠ¶æ€æœº<br/>State Machine]
        SM --> |å½“å‰çŠ¶æ€| ST[(çŠ¶æ€å­˜å‚¨<br/>- stage<br/>- context<br/>- history)]
    end
    
    subgraph "æ‰§è¡Œæ™ºèƒ½ä½“å±‚"
        DC --> |çŠ¶æ€: CULTURE_NEW| CA[æ–‡åŒ–åˆ†ææ™ºèƒ½ä½“]
        DC --> |çŠ¶æ€: CULTURE_MODIFY| CA
        DC --> |çŠ¶æ€: DESIGN_NEW| CD[åˆ›æ„è®¾è®¡æ™ºèƒ½ä½“]
        DC --> |çŠ¶æ€: DESIGN_MODIFY| CD
        DC --> |çŠ¶æ€: IMAGE_GEN| IG[å›¾åƒç”Ÿæˆæ™ºèƒ½ä½“]
        
        CA --> |execute æ–¹æ³•| CAR[åˆ†æç»“æœ]
        CA --> |modify æ–¹æ³•| CAR
        CD --> |execute æ–¹æ³•| CDR[è®¾è®¡æŠ¥å‘Š]
        CD --> |modify æ–¹æ³•| CDR
        IG --> |execute æ–¹æ³•| IGR[å›¾åƒæ•°æ®]
    end
    
    subgraph "å“åº”å¤„ç†"
        CAR --> RP[å“åº”å¤„ç†å™¨<br/>Response Processor]
        CDR --> RP
        IGR --> RP
        RP --> |é™„åŠ æ˜µç§°<br/>é™„åŠ åé¦ˆæç¤º| FR[æ ¼å¼åŒ–å“åº”]
        FR --> UI
    end
    
    ST -.-> |æä¾›ä¸Šä¸‹æ–‡| CA
    ST -.-> |æä¾›ä¸Šä¸‹æ–‡| CD
    ST -.-> |æä¾›ä¸Šä¸‹æ–‡| IG
    
    style M fill:#ff9999
    style DC fill:#99ccff
    style SM fill:#99ff99
    style CA fill:#ffcc99
    style CD fill:#ffcc99
    style IG fill:#ffcc99
  ```
  ![alt text](image.png)

### 2.2 æ•°æ®æµç¨‹

#### 2.2.1 å®Œæ•´å·¥ä½œæµç¨‹

```
é˜¶æ®µ1: æ–‡åŒ–åˆ†æ
ç”¨æˆ·è¾“å…¥ â†’ ç»ç†æ™ºèƒ½ä½“(æ„å›¾è§£æ) â†’ çŠ¶æ€æœº(CULTURE_NEW) 
â†’ æ–‡åŒ–æ™ºèƒ½ä½“(æ‰§è¡Œåˆ†æ) â†’ çŠ¶æ€æœº(CULTURE_WAIT,å­˜å‚¨ç»“æœ) 
â†’ ç”¨æˆ·(å±•ç¤ºæŠ¥å‘Š,è¯·æ±‚ç¡®è®¤)

é˜¶æ®µ2: è®¾è®¡æ–¹æ¡ˆç”Ÿæˆ
ç”¨æˆ·ç¡®è®¤ â†’ ç»ç†æ™ºèƒ½ä½“(è¯†åˆ«CONFIRM) â†’ çŠ¶æ€æœº(DESIGN_NEW,æºå¸¦æ–‡åŒ–ç»“æœ) 
â†’ è®¾è®¡æ™ºèƒ½ä½“(ç”Ÿæˆä¸‰æ–¹æ¡ˆ) â†’ çŠ¶æ€æœº(DESIGN_WAIT,å­˜å‚¨æ–¹æ¡ˆ) 
â†’ ç”¨æˆ·(å±•ç¤ºæ–¹æ¡ˆ,è¯·æ±‚é€‰æ‹©)

é˜¶æ®µ3: å›¾åƒç”Ÿæˆ
ç”¨æˆ·é€‰æ‹©+ä¿®æ”¹ â†’ ç»ç†æ™ºèƒ½ä½“(è¯†åˆ«SELECT+ä¿®æ”¹) 
â†’ çŠ¶æ€æœº(IMAGE_GEN,æºå¸¦æ–¹æ¡ˆ+ä¿®æ”¹+æ–‡åŒ–èƒŒæ™¯) 
â†’ å›¾åƒæ™ºèƒ½ä½“(ç”Ÿæˆprompt) â†’ çŠ¶æ€æœº(DONE) 
â†’ ç”¨æˆ·(å±•ç¤ºprompt)

ä¿®æ”¹å¾ªç¯:
ç”¨æˆ·ä¿®æ”¹è¯·æ±‚ â†’ ç»ç†æ™ºèƒ½ä½“(è¯†åˆ«MODIFY) 
â†’ ä¿æŒå½“å‰ç­‰å¾…çŠ¶æ€(CULTURE_WAIT/DESIGN_WAIT) 
â†’ å¯¹åº”æ™ºèƒ½ä½“(åŸºäºå†å²+åé¦ˆé‡æ–°æ‰§è¡Œ) 
â†’ è¿”å›ç­‰å¾…çŠ¶æ€ â†’ ç”¨æˆ·(å±•ç¤ºä¿®æ”¹ç»“æœ)
```

#### 2.2.2 çŠ¶æ€è½¬æ¢å›¾

```mermaid
stateDiagram-v2
    [*] --> INIT: ç”¨æˆ·å¼€å§‹å¯¹è¯
    
    INIT --> CULTURE_NEW: æ„å›¾: å¼€å§‹åˆ†æ
    
    CULTURE_NEW --> CULTURE_WAIT: æ–‡åŒ–åˆ†æå®Œæˆ
    
    CULTURE_WAIT --> CULTURE_MODIFY: æ„å›¾: ä¿®æ”¹åˆ†æ
    CULTURE_WAIT --> DESIGN_NEW: æ„å›¾: ç¡®è®¤åˆ†æ
    
    CULTURE_MODIFY --> CULTURE_WAIT: ä¿®æ”¹å®Œæˆ
    
    DESIGN_NEW --> DESIGN_WAIT: è®¾è®¡æ–¹æ¡ˆç”Ÿæˆå®Œæˆ
    
    DESIGN_WAIT --> DESIGN_MODIFY: æ„å›¾: ä¿®æ”¹è®¾è®¡
    DESIGN_WAIT --> IMAGE_GEN: æ„å›¾: é€‰æ‹©æ–¹æ¡ˆ
    
    DESIGN_MODIFY --> DESIGN_WAIT: ä¿®æ”¹å®Œæˆ
    
    IMAGE_GEN --> DONE: å›¾åƒç”Ÿæˆå®Œæˆ
    
    DONE --> [*]: æµç¨‹ç»“æŸ
```

#### 2.2.3 æ•°æ®æºå¸¦æœºåˆ¶

- **CULTURE_WAIT â†’ DESIGN_NEW**: æºå¸¦`culture_result`(æ–‡åŒ–åˆ†ææŠ¥å‘Š)
- **DESIGN_WAIT â†’ IMAGE_GEN**: æºå¸¦`design_schema[selected]`(é€‰ä¸­æ–¹æ¡ˆ) + `culture_result`(æ–‡åŒ–èƒŒæ™¯) + `modifications`(ç”¨æˆ·ä¿®æ”¹)
- **MODIFYæ“ä½œ**: æºå¸¦`previous_result`(ä¸Šæ¬¡ç»“æœ) + `user_feedback`(ç”¨æˆ·åé¦ˆ) + `history`(å¯¹è¯å†å²)

## 3. ä½¿ç”¨çš„ GenAI å·¥å…·

### 3.1 å¤§è¯­è¨€æ¨¡å‹

**é€šä¹‰åƒé—® (Qwen-Plus)**
- **ç”¨é€”**: 
  - æ‰€æœ‰æ™ºèƒ½ä½“çš„åº•å±‚LLMå¼•æ“
  - æ„å›¾è§£æå’Œè‡ªç„¶è¯­è¨€ç†è§£
  - ç»“æ„åŒ–ä¿¡æ¯ç”Ÿæˆ(JSONæ ¼å¼è¾“å‡º)
- **ä½¿ç”¨æ–¹å¼**:
  - é€šè¿‡é˜¿é‡Œäº‘DashScope APIè°ƒç”¨
  - é…ç½®åœ¨CrewAIçš„LLMå‚æ•°ä¸­
  - ä½¿ç”¨LangChainçš„ChatTongyiå°è£…
- **å…¸å‹é…ç½®**:
  ```python
  llm = ChatTongyi(
      model="qwen-plus",
      temperature=0.7,
      api_key=os.getenv("DASHSCOPE_API_KEY")
  )
  ```

### 3.2 å¼€å‘è¾…åŠ©å·¥å…·

**Claude (æœ¬å¯¹è¯)**
- **ç”¨é€”**:
  - ç³»ç»Ÿæ¶æ„è®¾è®¡å’¨è¯¢
  - ä»£ç ç»“æ„è§„åˆ’
  - æŠ€æœ¯é€‰å‹å»ºè®®
  - æ–‡æ¡£æ’°å†™è¾…åŠ©
- **ä½¿ç”¨åœºæ™¯**:
  - è®¾è®¡çŠ¶æ€æœºè½¬æ¢é€»è¾‘
  - ä¼˜åŒ–prompt engineering
  - è°ƒè¯•CrewAIé…ç½®é—®é¢˜
  - ç”Ÿæˆé¡¹ç›®æ–‡æ¡£æ¨¡æ¿



### 3.3 Promptå·¥ç¨‹

**å…³é”®Promptè®¾è®¡**:

1. **æ„å›¾è§£æPrompt** (ç»ç†æ™ºèƒ½ä½“):
```
åˆ†æç”¨æˆ·è¾“å…¥,è¿”å›JSONæ ¼å¼:
{
  "action": "NEW|CONFIRM|MODIFY|SELECT",
  "target": "CULTURE|DESIGN|IMAGE",
  "selection": æ–¹æ¡ˆç¼–å·(å¦‚é€‚ç”¨),
  "modifications": "ä¿®æ”¹è¦æ±‚æè¿°",
  "reasoning": "åˆ¤æ–­ä¾æ®"
}
```

2. **æ–‡åŒ–åˆ†æPrompt** (æ–‡åŒ–æ™ºèƒ½ä½“):
```
ä½œä¸ºä¹¡æ‘æ–‡åŒ–ç ”ç©¶å‘˜,åˆ†æä»¥ä¸‹ä¿¡æ¯:
[æ‘åº„æè¿°]
ä»ä»¥ä¸‹ç»´åº¦ç”ŸæˆæŠ¥å‘Š:
1. åœ°ç†ç¯å¢ƒ 2. å†å²æ–‡åŒ– 3. æ°‘ä¿—ç‰¹è‰² 4. äº§ä¸šç‰¹å¾
è¾“å‡ºJSONæ ¼å¼,æ¯é¡¹åŒ…å«è¯¦ç»†æè¿°å’Œè®¾è®¡å»ºè®®ã€‚
```

3. **è®¾è®¡æ–¹æ¡ˆPrompt** (è®¾è®¡æ™ºèƒ½ä½“):
```
åŸºäºæ–‡åŒ–åˆ†æ: [åˆ†æç»“æœ]
ç”Ÿæˆä¸‰ä¸ªå¢™ç»˜è®¾è®¡æ–¹æ¡ˆ:
- æ–¹æ¡ˆ1: ç°ä»£ç®€çº¦é£æ ¼
- æ–¹æ¡ˆ2: ä¼ ç»Ÿå·¥ç¬”é£æ ¼  
- æ–¹æ¡ˆ3: æŠ½è±¡è‰ºæœ¯é£æ ¼
æ¯ä¸ªæ–¹æ¡ˆåŒ…å«: ä¸»é¢˜/è‰²å½©/å…ƒç´ /æ„å›¾/é€‚ç”¨åœºæ™¯
```

## 4. é¡¹ç›®è®¾è®¡ä¸å®ç°è¯´æ˜

### 4.1 è®¾è®¡ç†å¿µ

**å¤šæ™ºèƒ½ä½“åä½œæ¨¡å¼**
- é‡‡ç”¨"ä¸“å®¶åˆ†å·¥+ä¸­å¤®åè°ƒ"æ¶æ„,é¿å…å•ä¸€æ™ºèƒ½ä½“å¤„ç†å¤æ‚ä»»åŠ¡å¯¼è‡´çš„è¾“å‡ºè´¨é‡ä¸‹é™
- æ¯ä¸ªæ™ºèƒ½ä½“ä¸“æ³¨äºç‰¹å®šé¢†åŸŸ,é€šè¿‡ç²¾ç»†åŒ–çš„è§’è‰²å®šä¹‰å’Œpromptæå‡ä¸“ä¸šæ€§
- ç»ç†æ™ºèƒ½ä½“ä½œä¸ºåè°ƒè€…,ä¸ç›´æ¥ç”Ÿæˆå†…å®¹,ä¸“æ³¨äºæµç¨‹æ§åˆ¶å’Œæ„å›¾ç†è§£

**çŠ¶æ€é©±åŠ¨çš„å·¥ä½œæµ**
- ä½¿ç”¨æœ‰é™çŠ¶æ€æœºç®¡ç†å¤æ‚çš„å¤šè½®å¯¹è¯æµç¨‹
- çŠ¶æ€è½¬æ¢è§„åˆ™æ˜¾å¼å®šä¹‰,é¿å…æ™ºèƒ½ä½“"è‡ªç”±å‘æŒ¥"å¯¼è‡´çš„æµç¨‹æ··ä¹±
- æ”¯æŒç”¨æˆ·åœ¨ä»»æ„é˜¶æ®µ"å›é€€"æˆ–"ä¿®æ”¹",å¢å¼ºäº¤äº’çµæ´»æ€§

**ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶**
- è®¾è®¡äº†å®Œæ•´çš„æ•°æ®æºå¸¦é“¾æ¡(CULTURE â†’ DESIGN â†’ IMAGE)
- ç¡®ä¿åç»­æ™ºèƒ½ä½“èƒ½å¤Ÿè·å–å‰ç½®é˜¶æ®µçš„å®Œæ•´ä¿¡æ¯
- é¿å…LLMä¸Šä¸‹æ–‡çª—å£é™åˆ¶é—®é¢˜(é€šè¿‡ç»“æ„åŒ–å­˜å‚¨ä¸­é—´ç»“æœ)

### 4.2 æ ¸å¿ƒå®ç°

#### 4.2.1 ç»ç†æ™ºèƒ½ä½“çš„æ„å›¾è§£æ

```python
class ManagerAgent:
    def parse_intent(self, user_input: str, current_state: str) -> dict:
        """
        ä½¿ç”¨LLMè§£æç”¨æˆ·æ„å›¾
        è¿”å›: {action, target, selection, modifications}
        """
        prompt = f"""
        å½“å‰çŠ¶æ€: {current_state}
        ç”¨æˆ·è¾“å…¥: {user_input}
        å†å²è®°å½•: {self.get_history()}
        
        åˆ†æç”¨æˆ·æ„å›¾å¹¶è¿”å›JSON...
        """
        response = self.llm.invoke(prompt)
        return json.loads(response.content)
```

**å…³é”®è®¾è®¡**:
- å°†å½“å‰çŠ¶æ€ä½œä¸ºä¸Šä¸‹æ–‡è¾“å…¥,å¸®åŠ©LLMç†è§£ç”¨æˆ·æ„å›¾(å¦‚"ç»§ç»­"åœ¨ä¸åŒçŠ¶æ€æœ‰ä¸åŒå«ä¹‰)
- ä½¿ç”¨JSON Schemaçº¦æŸè¾“å‡ºæ ¼å¼,æé«˜è§£æå¯é æ€§
- åŒ…å«`reasoning`å­—æ®µ,ç”¨äºè°ƒè¯•å’Œæ—¥å¿—è®°å½•

#### 4.2.2 çŠ¶æ€æœºå®ç°

```python
class WorkflowStateMachine:
    def __init__(self):
        self.state = "INIT"
        self.context = {}  # å­˜å‚¨ä¸­é—´ç»“æœ
        
    def transition(self, intent: dict) -> tuple[str, Agent]:
        """
        æ ¹æ®æ„å›¾å’Œå½“å‰çŠ¶æ€,è¿”å›(æ–°çŠ¶æ€, ç›®æ ‡æ™ºèƒ½ä½“)
        """
        rules = {
            ("INIT", "NEW", "CULTURE"): ("CULTURE_NEW", self.culture_agent),
            ("CULTURE_WAIT", "CONFIRM", "DESIGN"): ("DESIGN_NEW", self.design_agent),
            ("CULTURE_WAIT", "MODIFY", "CULTURE"): ("CULTURE_WAIT", self.culture_agent),
            # ... æ›´å¤šè§„åˆ™
        }
        
        key = (self.state, intent["action"], intent["target"])
        new_state, agent = rules.get(key, (self.state, None))
        self.state = new_state
        return new_state, agent
```

**ä¼˜åŠ¿**:
- è½¬æ¢è§„åˆ™é›†ä¸­ç®¡ç†,æ˜“äºç»´æŠ¤å’Œæ‰©å±•
- æ”¯æŒå¾ªç¯(å¦‚CULTURE_WAIT â†” CULTURE_MODIFY)
- å¯è®°å½•çŠ¶æ€è½¬æ¢å†å²,ç”¨äºåˆ†æç”¨æˆ·è¡Œä¸º

#### 4.2.3 CrewAIä»»åŠ¡ç¼–æ’

```python
from crewai import Crew, Task, Agent

# å®šä¹‰æ™ºèƒ½ä½“
culture_agent = Agent(
    role="æ–‡åŒ–ç ”ç©¶å‘˜",
    goal="æ·±åº¦åˆ†æä¹¡æ‘æ–‡åŒ–ç‰¹è‰²",
    backstory="æ‹¥æœ‰æ°‘ä¿—å­¦å’Œäººç±»å­¦èƒŒæ™¯...",
    llm=llm
)

# å®šä¹‰ä»»åŠ¡
culture_task = Task(
    description="""
    åˆ†ææ‘åº„: {village_info}
    è¾“å‡ºæ–‡åŒ–æŠ¥å‘Š,åŒ…å«: [ç»´åº¦åˆ—è¡¨]
    """,
    agent=culture_agent,
    expected_output="JSONæ ¼å¼çš„æ–‡åŒ–åˆ†ææŠ¥å‘Š"
)

# åˆ›å»ºCrew
crew = Crew(
    agents=[culture_agent, design_agent, image_agent],
    tasks=[culture_task],
    process=Process.sequential  # é¡ºåºæ‰§è¡Œ
)

result = crew.kickoff(inputs={"village_info": user_input})
```

**è®¾è®¡è¦ç‚¹**:
- ä½¿ç”¨CrewAIçš„`backstory`å¢å¼ºæ™ºèƒ½ä½“è§’è‰²è®¤çŸ¥
- `expected_output`æ˜ç¡®è¾“å‡ºæ ¼å¼,æé«˜ç»“æ„åŒ–ç¨‹åº¦
- åŠ¨æ€ä»»åŠ¡åˆ›å»º:æ ¹æ®çŠ¶æ€æœºåé¦ˆå®æ—¶æ„å»ºTask

#### 4.2.4 ChromaDBçŸ¥è¯†æ£€ç´¢

```python
import chromadb
from chromadb.utils import embedding_functions

# åˆå§‹åŒ–
client = chromadb.Client()
embedding_fn = embedding_functions.DefaultEmbeddingFunction()

collection = client.create_collection(
    name="village_cases",
    embedding_function=embedding_fn
)

# å­˜å‚¨æ¡ˆä¾‹
collection.add(
    documents=["å®‰å‰æ‘ä»¥ç«¹æ–‡åŒ–é—»å,è®¾è®¡é‡‡ç”¨æ°´å¢¨é£æ ¼..."],
    metadatas=[{"village": "å®‰å‰æ‘", "style": "æ°´å¢¨"}],
    ids=["case_001"]
)

# æ£€ç´¢ç›¸ä¼¼æ¡ˆä¾‹
def retrieve_similar_cases(query: str, n: int = 3):
    results = collection.query(
        query_texts=[query],
        n_results=n
    )
    return results["documents"][0]
```

**ç”¨é€”**:
- ä¸ºæ–‡åŒ–æ™ºèƒ½ä½“æä¾›ç±»ä¼¼æ‘åº„çš„å†å²æ¡ˆä¾‹
- ä¸ºè®¾è®¡æ™ºèƒ½ä½“æä¾›é£æ ¼å‚è€ƒ
- å®ç°çŸ¥è¯†å¢å¼ºçš„RAG(Retrieval-Augmented Generation)æ¨¡å¼

### 4.3 å…³é”®æŠ€æœ¯æŒ‘æˆ˜è§£å†³

**æŒ‘æˆ˜1: LLMè¾“å‡ºæ ¼å¼ä¸ç¨³å®š**
- **é—®é¢˜**: LLMæœ‰æ—¶è¿”å›å¸¦Markdownæ ‡è®°çš„JSON,æˆ–åŒ…å«é¢å¤–æ–‡æœ¬
- **è§£å†³**:
  - åœ¨promptä¸­å¼ºè°ƒ"ä»…è¿”å›JSON,æ— å…¶ä»–å†…å®¹"
  - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–JSONéƒ¨åˆ†: `re.search(r'\{.*\}', text, re.DOTALL)`
  - å¢åŠ å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶

**æŒ‘æˆ˜2: çŠ¶æ€æœºå¤æ‚åº¦ç®¡ç†**
- **é—®é¢˜**: éšç€æ”¯æŒçš„æ“ä½œå¢å¤š,çŠ¶æ€è½¬æ¢è§„åˆ™å‘ˆæŒ‡æ•°å¢é•¿
- **è§£å†³**:
  - å¼•å…¥"ç­‰å¾…çŠ¶æ€"(CULTURE_WAIT/DESIGN_WAIT)ä½œä¸ºå†³ç­–èŠ‚ç‚¹
  - ä½¿ç”¨çŠ¶æ€åˆ†ç»„(åˆ†æé˜¶æ®µ/è®¾è®¡é˜¶æ®µ/ç”Ÿæˆé˜¶æ®µ)ç®€åŒ–è§„åˆ™
  - ä¸ºæ¯ä¸ªçŠ¶æ€å®šä¹‰å¯æ¥å—çš„æ“ä½œåˆ—è¡¨,æå‰è¿‡æ»¤éæ³•è½¬æ¢

**æŒ‘æˆ˜3: ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜**
- **é—®é¢˜**: åç»­æ™ºèƒ½ä½“æ— æ³•è·å–å‰åºç»“æœçš„ç»†èŠ‚ä¿¡æ¯
- **è§£å†³**:
  - åœ¨çŠ¶æ€æœºçš„`context`å­—å…¸ä¸­æ˜¾å¼å­˜å‚¨æ¯ä¸ªé˜¶æ®µçš„å®Œæ•´è¾“å‡º
  - è®¾è®¡æ•°æ®æºå¸¦æ¨¡æ¿,ç¡®ä¿å¿…è¦ä¿¡æ¯ä¸é—æ¼
  - ä½¿ç”¨LangChainçš„Memoryæœºåˆ¶ä½œä¸ºè¡¥å……

**æŒ‘æˆ˜4: ç”¨æˆ·æ„å›¾æ­§ä¹‰**
- **é—®é¢˜**: "å†æ”¹æ”¹"ã€"ä¸å¤ªå¯¹"ç­‰æ¨¡ç³Šè¡¨è¾¾éš¾ä»¥è§£æ
- **è§£å†³**:
  - åœ¨æ„å›¾è§£æpromptä¸­æä¾›æ­§ä¹‰æ¡ˆä¾‹å’Œæ ‡å‡†è§£è¯»
  - å½“ç½®ä¿¡åº¦ä½æ—¶,ç”±ç»ç†æ™ºèƒ½ä½“ä¸»åŠ¨æ¾„æ¸…:"æ‚¨æ˜¯å¸Œæœ›ä¿®æ”¹æ–‡åŒ–åˆ†æ,è¿˜æ˜¯è®¾è®¡æ–¹æ¡ˆ?"
  - è®°å½•ç”¨æˆ·è¡¨è¾¾ä¹ æƒ¯,é€æ­¥é€‚åº”ä¸ªäººé£æ ¼

### 4.4 ç³»ç»Ÿé›†æˆ

#### 4.4.1 Streamlitå‰ç«¯

```python
import streamlit as st

st.title("ğŸ¨ ä¹¡æ‘å¢™ç»˜æ™ºèƒ½è®¾è®¡ç³»ç»Ÿ")

# æ˜¾ç¤ºå¯¹è¯å†å²
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# ç”¨æˆ·è¾“å…¥
if user_input := st.chat_input("æè¿°æ‚¨çš„æ‘åº„æˆ–æå‡ºä¿®æ”¹æ„è§"):
    # è°ƒç”¨åç«¯API
    response = orchestrator.process_input(user_input)
    
    # æ˜¾ç¤ºç»“æœ
    with st.chat_message("assistant"):
        if response["type"] == "culture_report":
            st.json(response["data"])
        elif response["type"] == "design_options":
            for i, option in enumerate(response["data"]):
                with st.expander(f"æ–¹æ¡ˆ{i+1}: {option['theme']}"):
                    st.write(option["description"])
        # ... å…¶ä»–ç±»å‹å¤„ç†
```

#### 4.4.2 FastAPIæœåŠ¡ç«¯

```python
from fastapi import FastAPI, WebSocket
from pydantic import BaseModel

app = FastAPI()

class ChatRequest(BaseModel):
    session_id: str
    message: str

@app.post("/chat")
async def chat_endpoint(request: ChatRequest):
    session = SessionManager.get_session(request.session_id)
    orchestrator = session.orchestrator
    
    result = orchestrator.process(request.message)
    return {
        "response": result.content,
        "state": orchestrator.state_machine.state,
        "metadata": result.metadata
    }
```

## 5. é‡åˆ°çš„æŒ‘æˆ˜ä¸æ”¶è·

### 5.1 ä¸»è¦æŒ‘æˆ˜

**1. æ™ºèƒ½ä½“è§’è‰²å®šä¹‰çš„ç²¾ç¡®æ€§**
- **é—®é¢˜**: åˆæœŸè§’è‰²å®šä¹‰æ¨¡ç³Šå¯¼è‡´æ™ºèƒ½ä½“è¾“å‡ºæ··ä¹±(å¦‚æ–‡åŒ–æ™ºèƒ½ä½“è‡ªä½œä¸»å¼ ç»™å‡ºè®¾è®¡å»ºè®®)
- **æ•™è®­**: éœ€è¦åœ¨`role`ã€`goal`ã€`backstory`ä¸­åå¤å¼ºè°ƒè¾¹ç•Œ,å¹¶åœ¨ä»»åŠ¡æè¿°ä¸­æ˜ç¡®"ä¸è¦åšä»€ä¹ˆ"

**2. çŠ¶æ€æœºè°ƒè¯•å›°éš¾**
- **é—®é¢˜**: å¤šè½®å¯¹è¯ä¸­çŠ¶æ€è½¬æ¢å¼‚å¸¸éš¾ä»¥å¤ç°å’Œå®šä½
- **è§£å†³**: å®ç°è¯¦ç»†çš„çŠ¶æ€è½¬æ¢æ—¥å¿—,è®°å½•æ¯æ¬¡è½¬æ¢çš„è§¦å‘æ¡ä»¶ã€æºå¸¦æ•°æ®ã€æ—¶é—´æˆ³

**3. LLMæˆæœ¬æ§åˆ¶**
- **é—®é¢˜**: æ¯æ¬¡æ„å›¾è§£æéƒ½è°ƒç”¨LLM,æˆæœ¬éšå¯¹è¯è½®æ¬¡çº¿æ€§å¢é•¿
- **ä¼˜åŒ–**: 
  - å¯¹äºç®€å•æ„å›¾(å¦‚çº¯æ•°å­—é€‰æ‹©)ä½¿ç”¨è§„åˆ™åŒ¹é…
  - ç¼“å­˜ç›¸ä¼¼æŸ¥è¯¢çš„è§£æç»“æœ
  - ä½¿ç”¨æ›´å°çš„æ¨¡å‹(å¦‚qwen-turbo)è¿›è¡Œæ„å›¾åˆ†ç±»

**4. å¹¶å‘ä¼šè¯ç®¡ç†**
- **é—®é¢˜**: å¤šç”¨æˆ·åŒæ—¶ä½¿ç”¨æ—¶,çŠ¶æ€æœºå®ä¾‹æ··æ·†
- **è§£å†³**: ä¸ºæ¯ä¸ªsession_idåˆ›å»ºç‹¬ç«‹çš„çŠ¶æ€æœºå®ä¾‹,ä½¿ç”¨SessionManagerç»Ÿä¸€ç®¡ç†

### 5.2 å…³é”®æ”¶è·

**1. å¤šæ™ºèƒ½ä½“åä½œçš„æœ€ä½³å®è·µ**
- ä¿æŒæ™ºèƒ½ä½“èŒè´£å•ä¸€,é¿å…"å…¨èƒ½æ™ºèƒ½ä½“"
- ä¸­å¤®åè°ƒè€…(ç»ç†)ä¸ç”Ÿæˆæœ€ç»ˆå†…å®¹,åªè´Ÿè´£è°ƒåº¦
- ä½¿ç”¨ç»“æ„åŒ–é€šä¿¡(JSON)è€Œéè‡ªç„¶è¯­è¨€åœ¨æ™ºèƒ½ä½“é—´ä¼ é€’ä¿¡æ¯

**2. çŠ¶æ€æœºåœ¨å¯¹è¯ç³»ç»Ÿä¸­çš„ä»·å€¼**
- æ˜¾å¼çŠ¶æ€ç®¡ç†æ¯”éšå¼ä¸Šä¸‹æ–‡ä¾èµ–æ›´å¯æ§
- çŠ¶æ€å›¾å¯ç›´æ¥ç”¨äºå‘ç”¨æˆ·è§£é‡Š"å½“å‰å¯ä»¥åšä»€ä¹ˆ"
- ä¾¿äºå®ç°æ’¤é”€ã€é‡åšç­‰é«˜çº§äº¤äº’åŠŸèƒ½

**3. RAGåœ¨å‚ç›´é¢†åŸŸçš„æ•ˆæœ**
- ChromaDBæ£€ç´¢çš„å†å²æ¡ˆä¾‹æ˜¾è‘—æå‡æ–‡åŒ–åˆ†æçš„æ·±åº¦
- ä½†éœ€è¦é«˜è´¨é‡çš„åˆå§‹æ•°æ®é›†(æ‰‹å·¥æ•´ç†äº†20+æ¡ˆä¾‹)
- æ£€ç´¢åˆ°çš„å†…å®¹éœ€è¦ç»è¿‡æ™ºèƒ½ä½“çš„"äºŒæ¬¡åŠ å·¥",ä¸èƒ½ç›´æ¥æ‹¼æ¥

**4. Promptå·¥ç¨‹çš„è¿­ä»£é‡è¦æ€§**
- æ¯ä¸ªæ™ºèƒ½ä½“çš„promptè‡³å°‘è¿­ä»£5æ¬¡ä»¥ä¸Šæ‰è¾¾åˆ°æ»¡æ„æ•ˆæœ
- Few-shotç¤ºä¾‹æ¯”çº¯æ–‡å­—è¯´æ˜æ›´æœ‰æ•ˆ
- å®šæœŸåˆ†æbadcase,å°†å¸¸è§é”™è¯¯çº³å…¥promptçš„è´Ÿé¢æ¡ˆä¾‹

### 5.3 æœªæ¥æ”¹è¿›æ–¹å‘

1. **å¼•å…¥äººç±»åé¦ˆå¼ºåŒ–å­¦ä¹ (RLHF)**:æ”¶é›†ç”¨æˆ·è¯„åˆ†æ•°æ®,å¾®è°ƒæ¨¡å‹ä»¥æå‡è®¾è®¡è´¨é‡

2. **å¤šæ¨¡æ€è¾“å…¥æ”¯æŒ**:å…è®¸ç”¨æˆ·ä¸Šä¼ æ‘åº„ç…§ç‰‡,ä½¿ç”¨è§†è§‰æ¨¡å‹æå–ç‰¹å¾è¾…åŠ©åˆ†æ

3. **å®æ—¶å›¾åƒç”Ÿæˆé›†æˆ**:å¯¹æ¥Stable Diffusion API,è®©ç”¨æˆ·ç«‹å³çœ‹åˆ°å¢™ç»˜æ•ˆæœå›¾

4. **åä½œæ¨¡å¼**:æ”¯æŒå¤šç”¨æˆ·(æ‘å§”ä¼š+è®¾è®¡å¸ˆ+æ‘æ°‘)å…±åŒå‚ä¸è®¾è®¡å†³ç­–

5. **çŸ¥è¯†å›¾è°±å¢å¼º**:æ„å»ºä¹¡æ‘æ–‡åŒ–çŸ¥è¯†å›¾è°±,æä¾›æ›´ç²¾å‡†çš„æ–‡åŒ–å…³è”åˆ†æ

## 6. å‚è€ƒèµ„æ–™

### 6.1 APIä¸æœåŠ¡æ–‡æ¡£

- **é€šä¹‰åƒé—®API**: https://dashscope.aliyun.com/
  - æ¨¡å‹æ–‡æ¡£: https://help.aliyun.com/zh/model-studio/developer-reference/
  - APIå‚è€ƒ: https://help.aliyun.com/zh/model-studio/developer-reference/api-reference

### 6.2 æ¡†æ¶ä¸å·¥å…·

- **CrewAIæ¡†æ¶**: https://docs.crewai.com/
  - Core Concepts: https://docs.crewai.com/core-concepts/Agents/
  - Task Management: https://docs.crewai.com/core-concepts/Tasks/
  
- **LangChain**: https://python.langchain.com/
  - Chat Models: https://python.langchain.com/docs/modules/model_io/chat/
  - Memory: https://python.langchain.com/docs/modules/memory/
  
- **ChromaDB**: https://docs.trychroma.com/
  - Getting Started: https://docs.trychroma.com/getting-started
  - Embeddings: https://docs.trychroma.com/embeddings

### 6.3 Webæ¡†æ¶

- **FastAPI**: https://fastapi.tiangolo.com/
  - Tutorial: https://fastapi.tiangolo.com/tutorial/
  - WebSocket: https://fastapi.tiangolo.com/advanced/websockets/
  
- **Streamlit**: https://docs.streamlit.io/
  - Chat Elements: https://docs.streamlit.io/library/api-reference/chat
  - Session State: https://docs.streamlit.io/library/api-reference/session-state

### 6.4 ç›¸å…³è®ºæ–‡ä¸æŠ€æœ¯åšå®¢

- **å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ**: 
  - "Communicative Agents for Software Development" (ChatDevè®ºæ–‡)
  - AutoGenæ¡†æ¶æŠ€æœ¯æŠ¥å‘Š: https://microsoft.github.io/autogen/
  
- **Promptå·¥ç¨‹**:
  - OpenAI Prompt Engineering Guide: https://platform.openai.com/docs/guides/prompt-engineering
  - Anthropic Prompt Library: https://docs.anthropic.com/claude/prompt-library

---
